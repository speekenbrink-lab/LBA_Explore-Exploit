#Simulate Sudden Uncertainty Onset
BanditSim <- function(params = c(1, 3, .2, .2, .5, 25, 0, 1, 3, 2, 20, .2), trialNum = 500) {
  
  rm('params')
  
  if (!exists('params')) {
    params <- c(.01, 1, .2, .2, .5, 25, 0, .01, 1, 2, 20, .5, 20)
  }
  
  if (!exists('trialNum')) {
    trialNum = 200
  }
  
  #Required packages and files----
  require('tidyverse')
  source('RW.R', TRUE)
  source('LBASim.R', TRUE)
  source('runBanditSimple.R', TRUE)
  source('runBandit_TwoLBA.R', TRUE)
  source('runBandit_SDunc.R', TRUE)
  source('runBandit_SPunc.R', TRUE)
  
  #Run the simple simulator? ----
  simpleSim <- 0
  
  #Run the dual accumulator?
  dualSim <- 0
  #Which type?
  dualSimType <- 1
  
  #Run the uncertainty SD accumulator
  sdSim <- 1
  #Which type?
  sdSimType <- 4
  
  #Run the uncertainty Start point accumulator 
  spSim <- 0
  spSimType <- 4
  
  #Set parameters (all in caps)----
  #Start-point bound for simple model or exploit
  A <- params[1]
  #Threshold
  B <- params[2]
  #Decision Delay
  T0 <- params[3]
  #Standard Deviation
  SD_V <- params[4]
  #Learning Rate
  ALPHA <- params[5]
  #Starting values
  QSTART <- params[6]
  #Scaling parameter for drift-rates
  PHI <- params[7]
  #Start point parameter for exploration
  A_EXPLORE <- params[8]
  #Threshold parameter for exploration
  B_EXPLORE <- params[9]
  #Standard deviation in drift rate for exploration
  SD_V_EXPLORE <- params[10]
  #Starting values for uncertainty
  UNCSTART <- params[11]
  #Scaling parameter for Uncertainty SDs
  GAMMA <- params[12]
  #Scaling parameter for Uncertainty SPs
  OMEGA <- params[13]
  
  #Number of simulations----
  simNum = 200
  
  #Choice and RT trackers ----
  simList <- matrix(ncol = simNum, nrow = trialNum)
  exploitList <- matrix(ncol = simNum, nrow = trialNum)
  tradExploitList <- matrix(ncol = simNum, nrow = trialNum)
  exploreList <- matrix(ncol = simNum, nrow = trialNum)
  RTList <- matrix(ncol = simNum, nrow = trialNum)
  
  #run one accumulator simple model ----
  if (simpleSim == 1) {
    for (p in 1:simNum) {
      sim <- runBanditSimple(A, B, T0, SD_V, ALPHA, QSTART, PHI, trialNum)
      simList[1:trialNum, p] <- sim$optimal
      tradExploitList[1:trialNum, p] <- sim$tradExploit
      RTList[1:trialNum, p] <- sim$rts
    }
  }
  
  #Run the two accumulator model ----
  if (dualSim == 1){
    for (p in 1:simNum) {
      sim <- runBandit_TwoLBA(A, B, T0, SD_V, ALPHA, QSTART, PHI,  
                              A_EXPLORE, B_EXPLORE, SD_V_EXPLORE, UNCSTART, GAMMA, 
                              trialNum, dualSimType)
      simList[1:trialNum, p] <- sim$optimal
      tradExploitList[1:trialNum, p] <- sim$traditionalExploit
      exploitList[1:trialNum, p] <- sim$exploit
      exploreList[1:trialNum, p] <- sim$explore
      RTList[1:trialNum, p] <- sim$rts
    }
  }
  
  #Uncertainty influences Standard deviation of responses ----
  if (sdSim == 1) {
    for (p in 1:simNum) {
      sim <- runBandit_SDunc(A, B, T0, ALPHA, QSTART, PHI,
                             UNCSTART, GAMMA, trialNum, sdSimType)
      simList[1:trialNum, p] <- sim$optimal
      tradExploitList[1:trialNum, p] <- sim$traditionalExploit
      RTList[1:trialNum, p] <- sim$rts
    }
  }
  
  #Uncertainty influences the Start point of response ----
  if (spSim == 1) {
    for (p in 1:simNum) {
      sim <- runBandit_SPunc(A, B, T0, SD_V, ALPHA, QSTART, PHI,
                             UNCSTART, OMEGA, trialNum, spSimType)
      simList[1:trialNum, p] <- sim$optimal
      tradExploitList[1:trialNum, p] <- sim$traditionalExploit
      RTList[1:trialNum, p] <- sim$rts
    }
  }
  
  #Collapse RTs into a single form ----
  for (p in 1:simNum) {
    holder <- data.frame(trial = 1:trialNum, averageRT = RTList[1:trialNum, p], exploit = tradExploitList[1:trialNum, p])
    if (p == 1) {
      RTFinal <- holder
    } else {
      RTFinal <- merge(RTFinal, holder, all = TRUE)
    }
  }
  
  #Make Graphs----
  
  condensedList <- apply(simList, 1, mean)
  tradExploitList <- apply(tradExploitList, 1, mean)
  exploitList <- apply(exploitList, 1, mean)
  exploreList <- apply(exploreList, 1, mean)
  
  condensedList <- data.frame(trial = 1:trialNum, averageScore = condensedList)
  tradExploitList <- data.frame(trial = 1:trialNum, averageTradExploit = tradExploitList)
  exploitList <- data.frame(trial = 1:trialNum, averageExploit = exploitList)
  exploreList <- data.frame(trial = 1:trialNum, averageExplore = exploreList)
  
  ggplot(data = condensedList, mapping = aes(x = trial, y = averageScore, group = 1)) +
    geom_line() +
    coord_cartesian(ylim = c(.3, 1))
  
  ggplot(data = tradExploitList, mapping = aes(x = trial, y = averageTradExploit, group = 1)) +
    geom_line() +
    coord_cartesian(ylim = c(.3, 1))
  
  RTFinal$exploit <- factor(RTFinal$exploit, levels = c(0, 1), labels = c('explore', 'exploit'))
  
  ggplot(data = RTFinal, mapping = aes(x = averageRT, fill = exploit)) +
    geom_histogram(binwidth = .2, position = 'dodge') +
    coord_cartesian(xlim = c(0, 8))
  
  # ggplot(data = exploitList, mapping = aes(x = trial, y = averageExploit, group = 1)) +
  #   geom_line() +
  #   coord_cartesian(ylim = c(0, 1))
  # 
  # ggplot(data = exploreList, mapping = aes(x = trial, y = averageExplore, group = 1)) +
  #   geom_line() +
  #   coord_cartesian(ylim = c(0, 1))
  #----
  
  return(condensedList)
}
