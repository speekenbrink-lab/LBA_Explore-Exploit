#Function to fit data from Uncertainty experiment
#Opening info ----
library('tidyverse')
library("R.matlab")
library('stats4')
library('nloptr')
library('rtdists')

source('LBAFit.R', local = TRUE)
source('LBApdf.R', TRUE)
source('LBAcdf.R', TRUE)
source('RW.R', TRUE)
source('readData.R', TRUE)
source('CMABFit.R', TRUE)
source('LBASim.R', TRUE)
source('runCMAB.R', TRUE)

source('CMABFit_rtdists.R', TRUE)

cond = 1 
pStart = 1
pNum = 1
trialNum = 512
secOneTrialNum = 256 
secTwoTrialNum = 256

trialPerformance <- matrix(ncol = pNum, nrow = trialNum)

params_S1 <- matrix(ncol = 14, nrow = pNum)
NLLs_S1 <- matrix(ncol = 2, nrow = pNum)
params_S2 <- matrix(ncol = 14, nrow = pNum)
NLLs_S2 <- matrix(ncol = 2, nrow = pNum)
S2QStart <- matrix(ncol = 8, nrow = pNum)

#Start Search ----
startPointSimple <- c(2.5, 2.5, 2.75, .5, 2, 7.5, 1, 1, .525, .525, 1, 0, 0)
upperSimple <- c(5, 5, 5, 1, 5, 15, 3, 2, 1, 1, 2, 0, 0)
lowerSimple <- c(0, 0, .5, 0, 0, 0, -1, 0, .05, .05, 0, 0, 0)
for (p in pStart:pNum) {
  rawData <- readData(trialNum, secOneTrialNum, secTwoTrialNum, cond, p)
  #Stage 1====
  #Optimisation options, first rough pass
  opts <- list("algorithm"="NLOPT_GN_DIRECT",
               "maxeval" = 10)
  
  # mle(CMABFit(params = startPoint, rawData = rawData), start = list(params = startPoint), fixed = list('rawData'))
  param <- nloptr(eval_f = CMABFit, 
                  x0 = startPointSimple,
                  lb = lowerSimple,
                  ub = upperSimple, 
                  opt = opts, rawData = rawData[1:secOneTrialNum,], 
                  trialNum = secOneTrialNum, S2QStart = NaN)

  #Optimisation options, second finer pass using parameters found previously
  opts <- list("algorithm"="NLOPT_GN_DIRECT_L",
               "maxeval" = 10)
  
  param <- nloptr(eval_f = CMABFit, 
                  x0 = param$solution,
                  lb = lowerSimple,
                  ub = upperSimple, 
                  opt = opts, rawData = rawData[1:secOneTrialNum,], 
                  trialNum = secOneTrialNum, S2QStart = NaN)
  
  params_S1[p, 1] <- p
  params_S1[p, 2:14] <- param$solution
  NLLs_S1[p, 1] <- p
  NLLs_S1[p, 2] <- param$objective
  

  #Simulate Stage1 With parameters to get QStart
  S2QStart[p,] <- runCMAB(params_S1[p, 2:14], 256, rawData[(secOneTrialNum + 1):(secOneTrialNum + secTwoTrialNum),], 'Test', S2QStart = NaN)
  
  #Stage 2====
  #Optimisation options, first rough pass
  opts <- list("algorithm"="NLOPT_GN_DIRECT",
               "maxeval" = 10)
  
  # mle(CMABFit(params = startPoint, rawData = rawData), start = list(params = startPoint), fixed = list('rawData'))
  param <- nloptr(eval_f = CMABFit, 
                  x0 = startPointSimple,
                  lb = lowerSimple,
                  ub = upperSimple, 
                  opt = opts, rawData = rawData[(secOneTrialNum + 1):(secOneTrialNum + secTwoTrialNum),], 
                  trialNum = secTwoTrialNum, S2QStart = S2QStart[p,])
  
  #Optimisation options, second finer pass using parameters found previously
  opts <- list("algorithm"="NLOPT_GN_DIRECT_L",
               "maxeval" = 10)
  
  param <- nloptr(eval_f = CMABFit, 
                  x0 = param$solution,
                  lb = lowerSimple,
                  ub = upperSimple, 
                  opt = opts, rawData = rawData[(secOneTrialNum + 1):(secOneTrialNum + secTwoTrialNum),], 
                  trialNum = secTwoTrialNum, S2QStart = S2QStart[p,])
  
  params_S2[p, 1] <- p
  params_S2[p, 2:14] <- param$solution
  NLLs_S2[p, 1] <- p
  NLLs_S2[p, 2] <- param$objective
  
}

#Run Simulations ----
#Number of simulations
simNum = 5
for (part in pStart:pNum) {
  #Choice and RT trackers ----
  simList <- matrix(ncol = simNum, nrow = secTwoTrialNum)
  tradExploitList <- matrix(ncol = simNum, nrow = secTwoTrialNum)
  RTList <- matrix(ncol = simNum, nrow = secTwoTrialNum)
  EV_DiffList <- matrix(ncol = simNum, nrow = secTwoTrialNum)
  Unc_MaxList <- matrix(ncol = simNum, nrow = secTwoTrialNum)
  
  for (k in 1:5) {
    if (k == 2 | k == 3 | k == 4 | k == 5) {
      next()
    }
    for (p in 1:simNum) {
      sim <- runCMAB(params_S2[part, 2:14], secTwoTrialNum, 0, 'Sim', S2QStart[part,])
      simList[1:secTwoTrialNum, p] <- sim$optimal
      tradExploitList[1:secTwoTrialNum, p] <- sim$optimal
      RTList[1:secTwoTrialNum, p] <- sim$rts
      EV_DiffList[1:secTwoTrialNum, p] <- sim$EV_Diff
      Unc_MaxList[1:secTwoTrialNum, p] <- sim$Unc_Max
    }
    condensedHolder <- apply(simList, 1, mean)
    tradExploitHolder <- apply(tradExploitList, 1, mean)
    
    #Handle Reaction Times
    for (p in 1:simNum) {
      holder <- data.frame(trial = 1:secTwoTrialNum, averageRT = RTList[1:secTwoTrialNum, p], exploit = tradExploitList[1:secTwoTrialNum, p],
                           EV_Diff = EV_DiffList[1:secTwoTrialNum, p], Unc_Max = Unc_MaxList[1:secTwoTrialNum, p])
      if (p == 1) {
        RTFinal <- holder
      } else {
        RTFinal <- merge(RTFinal, holder, all = TRUE)
      }
    }
    
    #Put them into One Holder tibble ----
    condensedHolder <- tibble(trial = 1:secTwoTrialNum, Optimal = condensedHolder, Model = k)
    tradExploitHolder <- tibble(trial = 1:secTwoTrialNum, Exploit = tradExploitHolder, Model = k)
    RTHolder <- tibble(trial = RTFinal$trial, RT = RTFinal$averageRT, Exploit = RTFinal$exploit,
                       EV_Diff = RTFinal$EV_Diff, Unc_Max = RTFinal$Unc_Max, 
                       Model = k)
    
    #Collect the tibbles!----
    if (!exists('condensedTib')) {
      condensedTib <-  condensedHolder
    } else {
      condensedTib <-  merge(condensedTib, condensedHolder, all = TRUE)
    }
    if (!exists('tradExploitTib')) {
      tradExploitTib <-  tradExploitHolder
    } else {
      tradExploitTib <-  merge(tradExploitTib, tradExploitHolder, all = TRUE)
    }
    if (!exists('RTTib')) {
      RTTib <-  RTHolder
    } else {
      RTTib <-  merge(RTTib, RTHolder, all = TRUE)
    }
  }
  
  #Make Graphs----
  print(ggplot(data = condensedTib, mapping = aes(x = trial, y = Optimal, group = 1)) +
    geom_line() +
    coord_cartesian(ylim = c(0, 1)) +
    facet_wrap(~ Model) +
    ggtitle('Optimal responding'))
  
  print(ggplot(data = tradExploitTib, mapping = aes(x = trial, y = Exploit, group = 1)) +
    geom_line() +
    coord_cartesian(ylim = c(0, 1)) +
    facet_wrap(~ Model) +
    ggtitle('Exploitation (Best known response)'))
  
  RTTib$Exploit <- factor(RTTib$Exploit, levels = c(0, 1), labels = c('explore', 'exploit'))
  
  print(ggplot(data = RTTib, mapping = aes(x = RT, fill = Exploit)) +
    geom_histogram(binwidth = .2, position = 'dodge') +
    coord_cartesian(xlim = c(0, 4)) +
    facet_wrap(~ Model) +
    ggtitle('Count of response times'))
  #
  rm('RTTib', 'tradExploitTib', 'condensedTib', 'condensedHolder', 'tradExploitHolder', 'RTHolder')
  
}

