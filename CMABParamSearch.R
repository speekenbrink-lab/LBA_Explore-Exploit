#Function to fit data from Uncertainty experiment
#Opening info ----
CMABParamSearch <- function(cond, LBAType, uncType, pStart, pNum) {
  library('tidyverse')
  library("R.matlab")
  library('stats4')
  library('nloptr')
  library('rtdists')
  
  source('LBAFit.R', local = TRUE)
  source('LBApdf.R', TRUE)
  source('LBAcdf.R', TRUE)
  source('RW.R', TRUE)
  source('readData.R', TRUE)
  source('CMABFit.R', TRUE)
  source('LBASim.R', TRUE)
  source('runCMAB.R', TRUE)
  source('addUncLBA.R', TRUE)
  
  source('CMABFit_rtdists.R', TRUE)
  
  # cond <- 1 
  # LBAType <- 3
  # uncType <- 2
  # pStart <- 2
  # pNum <- 2
  trialNum <- 512
  secOneTrialNum <- 256 
  secTwoTrialNum <- 256
  
  simNum <-  200 #needs 200 to save
  evalNum <- 500 #needs 500 to save
  
  trialPerformance <- matrix(ncol = pNum, nrow = trialNum)
  
  params_S1 <- matrix(ncol = 14, nrow = pNum)
  NLLs_S1 <- matrix(ncol = 2, nrow = pNum)
  params_S2 <- matrix(ncol = 14, nrow = pNum)
  NLLs_S2 <- matrix(ncol = 2, nrow = pNum)
  S2QStart <- matrix(ncol = 8, nrow = pNum)
  
  #Start Search ----
  if (LBAType == 1) {
    startPoint <- c(1.25, 1.25, 2.75, .5, 2, 7.5, 1, 1, .525, .525, 1, 10, 0)
    upper <- c(2.5, 2.5, 5, 1, 5, 15, 3, 2, 1, 1, 2, 10, 0)
    lower <- c(0, 0, .5, 0, 0, 0, -1, 0, .05, .05, 0, 10, 0)
  } else {
    startPoint <- c(1.25, 1.25, 2.75, .5, 2, 7.5, 1, 1, .525, .525, 1, 10, 2.5)
    upper <- c(2.5, 2.5, 5, 1, 5, 15, 3, 2, 1, 1, 2, 20, 5)
    lower <- c(0, 0, .5, 0, 0, 0, -1, 0, .05, .05, 0, 0, 0)
  }
  for (p in pStart:pNum) {
    rawData <- readData(trialNum, secOneTrialNum, secTwoTrialNum, cond, p)
    rawData <- mutate(rawData, comb = 0)
    #Calcualte cue combinations for uncertainty
    for (t in 1:trialNum) {
      if (rawData$cueOne[t] == 2 | rawData$cueTwo[t] == 2) {
        rawData$comb[t] <- 2
      }
      if (rawData$cueOne[t] == 3 | rawData$cueTwo[t] == 3) {
        rawData$comb[t] <- rawData$comb[t] + 1
      } else if (rawData$cueOne[t] == 4 | rawData$cueTwo[t] == 4) {
        rawData$comb[t] <- rawData$comb[t] + 2
      }
    }
    #Stage 1====
    #Optimisation options, first rough pass
    opts <- list("algorithm"="NLOPT_GN_DIRECT",
                 "maxeval" = evalNum)
    
    # mle(CMABFit(params = startPoint, rawData = rawData), start = list(params = startPoint), fixed = list('rawData'))
    param <- nloptr(eval_f = CMABFit, 
                    x0 = startPoint,
                    lb = lower,
                    ub = upper, 
                    opt = opts, rawData = rawData[1:secOneTrialNum,], 
                    trialNum = secOneTrialNum, S2QStart = NaN,
                    LBAType = LBAType, uncType = uncType)
  
    #Optimisation options, second finer pass using parameters found previously
    opts <- list("algorithm"="NLOPT_GN_DIRECT_L",
                 "maxeval" = evalNum)
    
    param <- nloptr(eval_f = CMABFit, 
                    x0 = param$solution,
                    lb = lower,
                    ub = upper, 
                    opt = opts, rawData = rawData[1:secOneTrialNum,], 
                    trialNum = secOneTrialNum, S2QStart = NaN,
                    LBAType = LBAType, uncType = uncType)
    
    params_S1[p, 1] <- p
    params_S1[p, 2:14] <- param$solution
    NLLs_S1[p, 1] <- p
    NLLs_S1[p, 2] <- param$objective
    
  
    #Simulate Stage1 With parameters to get QStart
    S2QStart[p,] <- runCMAB(params_S1[p, 2:14], 256, rawData[(secOneTrialNum + 1):(secOneTrialNum + secTwoTrialNum),], 'Test', S2QStart = NaN,
                            LBAType = LBAType, uncType = uncType)
    
    #Stage 2====
    #Optimisation options, first rough pass
    opts <- list("algorithm"="NLOPT_GN_DIRECT",
                 "maxeval" = evalNum)
    
    # mle(CMABFit(params = startPoint, rawData = rawData), start = list(params = startPoint), fixed = list('rawData'))
    param <- nloptr(eval_f = CMABFit, 
                    x0 = startPoint,
                    lb = lower,
                    ub = upper, 
                    opt = opts, rawData = rawData[(secOneTrialNum + 1):(secOneTrialNum + secTwoTrialNum),], 
                    trialNum = secTwoTrialNum, S2QStart = S2QStart[p,],
                    LBAType = LBAType, uncType = uncType)
    
    #Optimisation options, second finer pass using parameters found previously
    opts <- list("algorithm"="NLOPT_GN_DIRECT_L",
                 "maxeval" = evalNum)
    
    param <- nloptr(eval_f = CMABFit, 
                    x0 = param$solution,
                    lb = lower,
                    ub = upper, 
                    opt = opts, rawData = rawData[(secOneTrialNum + 1):(secOneTrialNum + secTwoTrialNum),], 
                    trialNum = secTwoTrialNum, S2QStart = S2QStart[p,],
                    LBAType = LBAType, uncType = uncType)
    
    params_S2[p, 1] <- p
    params_S2[p, 2:14] <- param$solution
    NLLs_S2[p, 1] <- p
    NLLs_S2[p, 2] <- param$objective
    
  }
  
  #Run Recovery ----
  params_S2_R <- matrix(ncol = 14, nrow = pNum)
  NLLs_S2_R <- matrix(ncol = 2, nrow = pNum)
  
  for (p in pStart:pNum) {
    sim <- runCMAB(params_S2[p, 2:14], secTwoTrialNum, 0, 'Sim', S2QStart[p,],
                   LBAType = LBAType, uncType = uncType)
    
    #Stage 2====
    #Optimisation options, first rough pass
    opts <- list("algorithm"="NLOPT_GN_DIRECT",
                 "maxeval" = evalNum)
    
    # mle(CMABFit(params = startPoint, rawData = rawData), start = list(params = startPoint), fixed = list('rawData'))
    param <- nloptr(eval_f = CMABFit, 
                    x0 = startPoint,
                    lb = lower,
                    ub = upper, 
                    opt = opts, rawData = sim, 
                    trialNum = secTwoTrialNum, S2QStart = S2QStart[p,],
                    LBAType = LBAType, uncType = uncType)
    
    #Optimisation options, second finer pass using parameters found previously
    opts <- list("algorithm"="NLOPT_GN_DIRECT_L",
                 "maxeval" = evalNum)
    
    param <- nloptr(eval_f = CMABFit, 
                    x0 = param$solution,
                    lb = lower,
                    ub = upper, 
                    opt = opts, rawData = sim, 
                    trialNum = secTwoTrialNum, S2QStart = S2QStart[p,],
                    LBAType = LBAType, uncType = uncType)
    
    params_S2_R[p, 1] <- p
    params_S2_R[p, 2:14] <- param$solution
    NLLs_S2_R[p, 1] <- p
    NLLs_S2_R[p, 2] <- param$objective
    
  }
  
  #Run Simulations ----
  #Number of simulations
  for (part in pStart:pNum) {
    #Choice and RT trackers ----
    simList <- matrix(ncol = simNum, nrow = secTwoTrialNum)
    tradExploitList <- matrix(ncol = simNum, nrow = secTwoTrialNum)
    RTList <- matrix(ncol = simNum, nrow = secTwoTrialNum)
    EV_DiffList <- matrix(ncol = simNum, nrow = secTwoTrialNum)
    Unc_MaxList <- matrix(ncol = simNum, nrow = secTwoTrialNum)
    
    for (k in 1:5) {
      if (k == 2 | k == 3 | k == 4 | k == 5) {
        next()
      }
      for (p in 1:simNum) {
        sim <- runCMAB(params_S2[part, 2:14], secTwoTrialNum, 0, 'Sim', S2QStart[part,], LBAType = LBAType, uncType = uncType)
        simList[1:secTwoTrialNum, p] <- sim$optimal
        tradExploitList[1:secTwoTrialNum, p] <- sim$optimal
        RTList[1:secTwoTrialNum, p] <- sim$RT
        EV_DiffList[1:secTwoTrialNum, p] <- sim$EV_Diff
        Unc_MaxList[1:secTwoTrialNum, p] <- sim$Unc_Max
      }
      condensedHolder <- apply(simList, 1, mean)
      tradExploitHolder <- apply(tradExploitList, 1, mean)
      
      #Handle Reaction Times
      for (p in 1:simNum) {
        holder <- data.frame(trial = 1:secTwoTrialNum, averageRT = RTList[1:secTwoTrialNum, p], exploit = tradExploitList[1:secTwoTrialNum, p],
                             EV_Diff = EV_DiffList[1:secTwoTrialNum, p], Unc_Max = Unc_MaxList[1:secTwoTrialNum, p])
        if (p == 1) {
          RTFinal <- holder
        } else {
          RTFinal <- merge(RTFinal, holder, all = TRUE)
        }
      }
      
      #Put them into One Holder tibble ----
      condensedHolder <- tibble(trial = 1:secTwoTrialNum, Optimal = condensedHolder, Model = k)
      tradExploitHolder <- tibble(trial = 1:secTwoTrialNum, Exploit = tradExploitHolder, Model = k)
      RTHolder <- tibble(trial = RTFinal$trial, RT = RTFinal$averageRT, Exploit = RTFinal$exploit,
                         EV_Diff = RTFinal$EV_Diff, Unc_Max = RTFinal$Unc_Max, 
                         Model = k)
      
      #Collect the tibbles!----
      if (!exists('condensedTib')) {
        condensedTib <-  condensedHolder
      } else {
        condensedTib <-  merge(condensedTib, condensedHolder, all = TRUE)
      }
      if (!exists('tradExploitTib')) {
        tradExploitTib <-  tradExploitHolder
      } else {
        tradExploitTib <-  merge(tradExploitTib, tradExploitHolder, all = TRUE)
      }
      if (!exists('RTTib')) {
        RTTib <-  RTHolder
      } else {
        RTTib <-  merge(RTTib, RTHolder, all = TRUE)
      }
    }
    
    #Make Graphs----
    print(ggplot(data = tradExploitTib, mapping = aes(x = trial, y = Exploit, group = 1)) +
      geom_line() +
      coord_cartesian(ylim = c(0, 1)) +
      facet_wrap(~ Model) +
      ggtitle('Exploitation (Best known response)'))
    
    if (simNum >= 200 & evalNum >= 500) {
      graphName <- paste(c("Sim_Data/OptResp_C",cond,"_S",part,'_LBA', LBAType,'_Unc', uncType,'.png'), collapse = '')
      ggsave(filename = graphName, width = 10, height = 8)
    }
    
    RTTib$Exploit <- factor(RTTib$Exploit, levels = c(0, 1), labels = c('explore', 'exploit'))
    
    print(ggplot(data = RTTib, mapping = aes(x = RT, fill = Exploit)) +
      geom_histogram(binwidth = .2, position = 'dodge') +
      coord_cartesian(xlim = c(0, 4)) +
      facet_wrap(~ Model) +
      ggtitle('Count of response times'))
    
    if (simNum >= 200 & evalNum >= 500) {
      graphName <- paste(c("Sim_Data/RespTime_C",cond,"_S",part,'_LBA', LBAType,'_Unc', uncType,'.png'), collapse = '')
      ggsave(filename = graphName, width = 10, height = 8)
    }
    
    #Real RTs
    rawData <- readData(trialNum, secOneTrialNum, secTwoTrialNum, cond, part)
    testBlock <- filter(rawData, trial > secOneTrialNum) %>% 
      mutate(Optimal = case_when((cueOne ==1 | cueTwo == 1) & choice == 1 ~ 1,
                                  (cueOne == 2| cueTwo == 2) & choice == 2 ~ 1,
                                  (cueOne ==1 | cueTwo == 1) & choice == 2 ~ 0,
                                  (cueOne == 2| cueTwo == 2) & choice == 1 ~ 0))
                                  
    ggplot(data = testBlock, aes(x = RT, colour = factor(Optimal), group = factor(Optimal))) +
      geom_freqpoly(binwidth = .15, position = 'dodge', size = 1) +
      coord_cartesian(xlim = c(0, 4))
    
    filename <- paste(c("Sim_Data/Data_C",cond,"_S",part,'_LBA', LBAType,'_Unc', uncType,'.rdata'), collapse = '')
    
    if (simNum >= 200 & evalNum >= 500) {
      save(file = filename, list = c('RTTib', 'tradExploitTib', 'condensedTib', 'params_S1' ,'params_S2', 'NLLs_S1', 'NLLs_S2', 'params_S2_R', 'NLLs_S2_R', 'S2QStart'))
    }
    
    rm('RTTib', 'tradExploitTib', 'condensedTib', 'condensedHolder', 'tradExploitHolder', 'RTHolder')
    
  }

}