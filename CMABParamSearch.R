#Function to fit data from Uncertainty experiment
library('tidyverse')
library("R.matlab")
library('stats4')
library('nloptr')

source('LBAFit.R', local = TRUE)
source('LBApdf.R', TRUE)
source('LBAcdf.R', TRUE)
source('RW.R', TRUE)
source('readData.R', TRUE)
source('CMABFit.R', TRUE)
source('runPart.R', TRUE)
source('LBASim.R', TRUE)
source('CMABSim.R', TRUE)

cond = 1 
pStart = 1
pNum = 1
trialNum = 448
secOneTrialNum = 256 
secTwoTrialNum = 192

trialPerformance <- matrix(ncol = pNum, nrow = trialNum)

params <- matrix(ncol = 7, nrow = pNum)
NLLs <- rep(0, nrom = pNum)

#Optimisation options
opts <- list("algorithm"="NLOPT_GN_DIRECT",
             "xtol_rel"=1.0e-3,
             "maxeval" = 500)

for (p in pStart:pNum) {
  rawData <- readData(trialNum, secOneTrialNum, secTwoTrialNum, cond, p)
  # rawData <- data.matrix(rawData)
  
  #Optimisation options, first rough pass
  opts <- list("algorithm"="NLOPT_GN_DIRECT",
               "xtol_rel"=1.0e-6,
               "maxeval" = 500)
  
  # mle(CMABFit(params = startPoint, rawData = rawData), start = list(params = startPoint), fixed = list('rawData'))
  param <- nloptr(x0 = c(5, 5, 5, 5, .525, 15, 5), eval_f = CMABFit, lb = c(0, .5, 0, .01, .05, 0, 1), 
                  ub = c(10, 10, 10, 5, 1, 30, 10), opt = opts, rawData = rawData)
  
  #Optimisation options, second finer pass using parameters found previously
  opts <- list("algorithm"="NLOPT_GN_DIRECT_L",
               "xtol_rel"=1.0e-8,
               "maxeval" = 500)
  
  # param <- nloptr(x0 = param$solutions, eval_f = CMABFit, lb = c(0, .5, 0, .01, .05, 0, 1), 
  #                 ub = c(10, 10, 10, 5, 1, 30, 10), opt = opts, rawData = rawData)

  params[p,] <- param$solution
  NLLs[p] <- param$objective
  
  # test <- CMABSim(params[p,])
  # trialPerformance[1:trialNum, p] <- test$averageScore
}

