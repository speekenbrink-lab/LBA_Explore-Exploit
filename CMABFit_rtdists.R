# CMABFit <- function(A = .5, B = 3, T0 = .3, MEAN_V = 2, SD_V = 1, ALPHA = .4, QSTART = .1, rawData) {
CMABFit_rtdists <- function(params, rawData, trialNum) {
  
  # #Temp variables
  # #Start point variability
  A <- params[1]
  # #Threshold
  B <- params[2]
  # #Time to start accumulation
  T0 <- params[3]
  # #Drift Rates (decided in the code)
  # MEAN_V <- rep(params[4], times = 2)
  # #Standard deviation of drift rates
  SD_V <- rep(params[4], times = 2)
  # #Learning rate
  ALPHA <- params[5]
  # #Start point for values
  QSTART <- params[6]
  # #
  PHI <- params[7]
  
  print(params)
  
  #Paramter Bounding ----
  # if (A < 0 | A > 10){
  #   NLL <- 100000
  #   return(NLL)
  # } else if (B < .5 | B > 10){
  #   NLL <- 100000  
  #   return(NLL)
  # } else if (T0 < 0 | T0 > 10){
  #   NLL <- 100000  
  #   return(NLL)
  # } else if (SD_V[1] <= 0 | SD_V[1] > 5){
  #   NLL <- 100000 
  #   return(NLL)
  # } else if (ALPHA < .05 | ALPHA > 1){
  #   NLL <- 100000  
  #   return(NLL)
  # } else if (QSTART < 0 | QSTART > 30){
  #   NLL <- 100000 
  #   return(NLL)
  # } else if (PHI < 1 | PHI > 10){
  #   NLL <- 100000  
  #   return(NLL)
  # }
  
  #Ensure A is less than B ----
  if (is.null(params)) {
    NLL <- 1000001
    return(NLL)
  }
  
  
  if (A > B) {
    NLL <- 1000001
    print(NLL)
    return(NLL)
  }
  
  #Set trial info
  choiceNum = 2
  
  #Perform Learning in Trials
  
  #Q values for each action
  Qs <- rep(QSTART, times = 8)
  QTable <- matrix(ncol = 8, nrow = trialNum)
  #Mean values for each response given the cues
  trialVals <- rep(0, times = 2)
  #Likelihoods of the response
  likelihood <- rep(0, times = trialNum)
  tempLikelihoods <- rep(0, times = 2)
  
  #Including T0? Take it away from RTs before running the model?
  rawData <- mutate(rawData, fixedRT = RT - T0)
  
  driftRates <- matrix(ncol = 2, nrow = trialNum)
  
  for (t in 1:trialNum){
    #Which cues are on screen
    cuesPres <- rep(NA, times = 4)
    #Find cues in the trial
    cuesPres[rawData$cueOne[t]] <- 1
    cuesPres[rawData$cueTwo[t]] <- 1
    
    QTable[t, 1:8] <- Qs
    
    #Learn based on decision
    if (rawData$choice[t] == 1) {
      Qs[1:4] <- RW(ALPHA, Qs[1:4], rawData$reward[t], cuesPres)
    } else if (rawData$choice[t] == 2) {
      Qs[5:8] <- RW(ALPHA, Qs[5:8], rawData$reward[t], cuesPres)
    }
    
    #Work out likelihood of making that response
    #Transform presented cues for values for each choice
    trialVals[1] <- mean(cuesPres*QTable[t, 1:4], na.rm = TRUE)
    trialVals[2] <- mean(cuesPres*QTable[t, 5:8], na.rm = TRUE)
    
    #Transform expected value into mean-driftrate
    driftRates[t, 1:2] <- (trialVals)/PHI
    
    #Get likelihoods
    likelihood[t] <- n1CDF(rt = rawData$RT[t], response = rawData$choice[t], 
                       A = A, b = B, t0 = T0, mean_v = driftRates[t, 1:2], sd_v = SD_V, silent = TRUE)
    
  }
  
  # likelihood <- array(as.numeric(unlist(likelihood)))
  
  NLL = -sum(log(likelihood), na.rm = TRUE)
  
  print(NLL)
  return(NLL)
  
}